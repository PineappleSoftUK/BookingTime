/*
Assets, update a asset
*/

//First some functions...

//Returns the current time of the object as a string, needed for showTimeslots function
class TimeString extends Date {

  //Function to add leading zero's
  pad(num, size) {
    var s = "000000000" + num;
    return s.substr(s.length - size);
  }

  //Function to return the current time of the date object as a string
  timeAsString() {
    var time;
    time = this.pad(this.getHours(), 2) + ":" + this.pad(this.getMinutes(), 2);
    return time;
  }
  //Function to set the day to a given weekday
  setWeekday(weekday) {
    var currentDay = this.getDay();
    var distance = weekday - currentDay;
    this.setDate(this.getDate() + distance);
  }
}


//Add timeslot checkboxes to form based on timeslot length
function showTimeslots() {

  var timeslotLength = parseInt($('#timeslotLength').val());
  var timeslotStart = parseInt($('#timeslotStart').val());
  var numberOfTimeslots = 1440 / timeslotLength;
  var clock = new TimeString();

  //First remove any checkboxes previously generated by js from the form
  $("#timeslotsContainer").empty();

  //Set the clock to Monday
  clock.setWeekday(1);

  //Display helpful message
  $('#timeslotsContainer').append('<br> <p>Tick the boxes below to indicate when this asset will be available to book each day...</p>');

  for (let i = 0; i < 7; i++) { //For each day

    //Set the clock to first timeslot of the day
    clock.setHours(0, parseInt(timeslotStart), 0);

    //Get day name and add to container
    var dayName = clock.toLocaleDateString("en-GB", {
      weekday: 'long'
    });
    $('#timeslotsContainer').append('<br> <p>' + dayName + '</p>');

    for (let j = 0; j < numberOfTimeslots; j++) { //For each timeslot
      var checkboxTime = clock.timeAsString();

      $('#timeslotsContainer')
        .append('<input class ="' + dayName + '" type="checkbox" name="' + i + '_' + checkboxTime + '" value="' + checkboxTime + '">')
        .append('<label for="' + i + '_' + checkboxTime + '">' + checkboxTime + '</label></div>')
        .append('<br>');

      //Increment the clock by the timeslot duration
      clock.setMinutes(clock.getMinutes() + timeslotLength);
    }
  }
}


//Now start to render the page...

// get asset id
var url = new URL(window.location.href);
var id = decodeURIComponent(url.searchParams.get("id"));

// validate jwt to verify access
var jwt = getCookie('jwt');
$.post(apiPath + "api/users/validate_token.php", JSON.stringify({ jwt:jwt })).done(function(result) {

  // read one record based on given asset id
  $.getJSON(apiPath + "api/asset/read_one.php?id=" + id, function(data){

    // values will populate the form
    var name = data.name;
    var location = data.location;
    var capacity = data.capacity;
    var timeslotStart = data.timeslotStart;
    var timeslotLength = data.timeslotLength;
    var timeslots = data.timeslots;
    var status = data.status;

    $.getJSON(apiPath + "api/location/read.php", function(data){

      // build locations list
      var categories_options_html=`<select name='location'>`;
      $.each(data.records, function(key, val){
        //pre-select option is category id is the same
        if(val.id==location){ categories_options_html+=`<option value='` + val.id + `' selected>` + val.name + `</option>`; }

        else{ categories_options_html+=`<option value='` + val.id + `'>` + val.name + `</option>`; }
      });

      categories_options_html+=`</select>`;

      // Build the form
      var update_asset_html=`

          <!-- Go back button -->
          <button id='go-home-button' class='styledButton greyBtn' onclick="location.href='index.html';">
            &lt; Go Back
          </button>
          <!-- 'update asset' html form -->
          <form id='update-asset-form' action='#' method='post' border='0'>

            <label for="update-form-category">Location</label>
            ` + categories_options_html + `

            <label for="update-form-name">Name</label>
            <input type='text' name='name' id="update-form-name" value="` + name + `" required />

            <label for="update-form-capacity">Capacity</label>
            <input type='number' min='1' name='capacity' id="update-form-capacity" value="` + capacity + `" required />

            <input type="hidden" id="status" name="status" value="Live">

            <label for="timeslotLength" id="timeslotLengthLabel">Length of each timeslot (in minutes):</label><br>
            <input type="number" id="timeslotLength" name="timeslotLength" min="1" max="1440" value="` + timeslotLength + `"><br>

            <label for="timeslotStart" id="timeslotStartLabel">Start timeslots at (minutes past the hour):</label><br>
            <input type="number" id="timeslotStart" name="timeslotStart" min="0" max="59" value="` + timeslotStart + `"><br>

            <button type="button" class='styledButton createBtn' name="showTimeslotsBtn" onclick="showTimeslots()">Refresh Timeslots</button>

            <div id="timeslotsContainer">
              <!--JS will populate checkboxes here-->
            </div>

            <!-- hidden 'location id' to identify which record to delete -->
            <input value=\"` + id + `\" name='id' type='hidden' />

            <button type='submit'>Save Changes</button>

          </form>`;

      // inject html to 'page-content'
      $("#content").html(update_asset_html);

      //display timeslots
      showTimeslots();

      //Now tick the relevent timeslots
      //First, get the raw timeslots string and convert to js object.
      var timeslotsReadObj = JSON.parse(timeslots.replace(/&quot;/g,'"'));

      //loop each timeslot and check to see if it needs to be ticked.
      $('input[type=checkbox]').each(function () { //for each checkbox
        var itemDayName = $(this).prop('className');
        var itemTime = $(this).val();

        if (timeslotsReadObj[itemDayName].includes(itemTime)) { //if 'day' property (which is an array of valid times) of 'timeslotsObj' object contains this time
          $(this).prop('checked', true);
        }

      });
    });
  });
})
// show login page on error
.fail(function(result){
  var alertMessage = encodeURIComponent("Please login to access this page");
  window.location.href = "../users/index.html?alert_type=error&alert_text=" + alertMessage;
});

// will run if 'update asset' form was submitted
$(document).on('submit', '#update-asset-form', function(){

  var timeslotsObj = {
    Monday: [],
    Tuesday: [],
    Wednesday: [],
    Thursday: [],
    Friday: [],
    Saturday: [],
    Sunday: []
  };

  //This will loop through the checkboxes and add selected values to timeslotJSON
  $(":checkbox").each(function() {
    if ($(this).is(':checked')) {
      timeslotsObj[$(this).prop('className')].push($(this).val()); //Get checkbox class name then push the value to that index
    }
  });

  //Now add this array to the form 'post' data by way of a hidden element:
  var input = $("<input>")
    .attr("type", "hidden")
    .attr("name", "timeslots").val(JSON.stringify(timeslotsObj));
  $('#update-asset-form').append(input);

  // get form data
  var form_data=JSON.stringify($(this).serializeObject());
  // submit form data to api
  $.ajax({
    url: apiPath + "api/asset/update.php",
    type : "POST",
    contentType : 'application/json',
    //send jwt header
    headers: {
      Authorization: 'Bearer ' + getCookie('jwt')
    },
    data : form_data,
    success : function(result) {
      // asset was updated, go back to assets list
      var alertMessage = encodeURIComponent("Asset successfully updated");
      window.location.href = "index.html?alert_type=success&alert_text=" + alertMessage;
    },
    error: function(xhr, resp, text) {
      // show error to console
      var alertMessage = encodeURIComponent("Update asset failed: " + xhr.responseJSON.message);
      window.location.href = "index.html?alert_type=error&alert_text=" + alertMessage;
    }
  });

    return false;
});
